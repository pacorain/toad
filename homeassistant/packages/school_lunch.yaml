# Pull school lunches

# Expose an action to pull school lunches from the school's portal
rest_command:
  school_lunch:
    url: !secret local_url_school_lunch
    method: GET
    headers: 
      User-Agent: !secret info_user_agent
    content_type: 'application/json'
    timeout: 10

# Script to parse the school lunch data
script:
  update_school_lunch:
    sequence:
      - alias: Set dates
        variables:
          startDate: "{{ startDate | default(now().strftime('%-m/%-d/%Y')) }}"
          endDate: "{{ endDate | default(strptime(startDate, '%m/%d/%Y')) + timedelta(days=7) }}"
      
      - alias: Pull school lunch data
        service: rest_command.school_lunch
        data:
          startDate: "{{ startDate }}"
          endDate: "{{ endDate }}"
        response_variable: school_lunch_data
     
      - alias: Check for error
        if: |
          "{{ school_lunch_data.status_code != 200 }}"
        then:
          - event: rest_failed
            event_data:
              status_code: "{{ school_lunch_data.status_code }}"
              url: !secret local_url_school_lunch
              body: "{{ school_lunch_data.content | default('') }}"
          - stop: "Failed with status code {{ school_lunch_data.status_code }}"
            error: true
      
      - alias: Parse school lunch data
        service: python_script.parse_school_lunch
        data: |
          {{ school_lunch_data }}
        response_variable: daily_lunches
